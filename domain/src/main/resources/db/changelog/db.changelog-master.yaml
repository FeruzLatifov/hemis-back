databaseChangeLog:
  # =====================================================
  # HEMIS DATABASE MIGRATIONS
  # =====================================================
  # Industry Best Practices (Large Project Structure):
  # - Nested structure: schema/, seed/, migration/
  # - 1 file = 1 table (granular changesets)
  # - preConditions instead of IF NOT EXISTS
  # - Idempotent seeds (ON CONFLICT DO UPDATE)
  # - Rollback scripts alongside main files
  # - logicalFilePath ensures consistent identity across Gradle/Spring
  # - splitStatements: false for PL/pgSQL blocks (DO $$...$$)
  # =====================================================

  # Global property for consistent changelog path
  - property:
      name: changelog.path
      value: db/changelog/db.changelog-master.yaml

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PHASE 1: SCHEMA (DDL) - changesets/schema/
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  - changeSet:
      id: V001_create_users
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: users
      changes:
        - sqlFile:
            path: changesets/schema/V001_create_users.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V001_create_users_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V002_create_roles
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: roles
      changes:
        - sqlFile:
            path: changesets/schema/V002_create_roles.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V002_create_roles_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V003_create_permissions
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: permissions
      changes:
        - sqlFile:
            path: changesets/schema/V003_create_permissions.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V003_create_permissions_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V004_create_user_roles
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: user_roles
      changes:
        - sqlFile:
            path: changesets/schema/V004_create_user_roles.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V004_create_user_roles_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V005_create_role_permissions
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: role_permissions
      changes:
        - sqlFile:
            path: changesets/schema/V005_create_role_permissions.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V005_create_role_permissions_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V006_create_system_messages
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: system_messages
      changes:
        - sqlFile:
            path: changesets/schema/V006_create_system_messages.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V006_create_system_messages_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V007_create_system_message_translations
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: system_message_translations
      changes:
        - sqlFile:
            path: changesets/schema/V007_create_system_message_translations.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V007_create_system_message_translations_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V008_create_menus
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: menus
      changes:
        - sqlFile:
            path: changesets/schema/V008_create_menus.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V008_create_menus_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V009_create_languages
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: languages
      changes:
        - sqlFile:
            path: changesets/schema/V009_create_languages.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V009_create_languages_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: V010_create_language_translations
      author: hemis-team
      logicalFilePath: ${changelog.path}
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: language_translations
      changes:
        - sqlFile:
            path: changesets/schema/V010_create_language_translations.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/schema/V010_create_language_translations_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: tag-schema-complete
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - tagDatabase:
            tag: schema-v1.0

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PHASE 2: SEED DATA (DML) - changesets/seed/
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  - changeSet:
      id: S001_seed_roles
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S001_seed_roles.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S001_seed_roles_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S002_seed_permissions_core
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S002_seed_permissions_core.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S002_seed_permissions_core_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S003_seed_permissions_admin
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S003_seed_permissions_admin.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S003_seed_permissions_admin_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S003b_seed_permissions_menu
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S003b_seed_permissions_menu.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S003b_seed_permissions_menu_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S004_seed_role_permissions
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S004_seed_role_permissions.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S004_seed_role_permissions_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S005_seed_languages
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/seed/S005_seed_languages.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S005_seed_languages_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: S006_seed_translations
      author: hemis-team
      logicalFilePath: ${changelog.path}
      runOnChange: true
      changes:
        - sqlFile:
            path: changesets/seed/S006_seed_translations.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/seed/S006_seed_translations_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: tag-seed-complete
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - tagDatabase:
            tag: seed-v1.0

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PHASE 3: MIGRATION (Legacy Data) - changesets/migration/
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  - changeSet:
      id: M001_migrate_old_hemis_users
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - sqlFile:
            path: changesets/migration/M001_migrate_old_hemis_users.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/migration/M001_migrate_old_hemis_users_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: M002_fix_permission_leak
      author: hemis-team
      logicalFilePath: ${changelog.path}
      comment: "Fix SQL operator precedence bug that leaked system.* permissions to non-admin roles"
      changes:
        - sqlFile:
            path: changesets/migration/M002_fix_permission_leak.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/migration/M002_fix_permission_leak_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: M003_fix_changelog_filenames
      author: hemis-team
      logicalFilePath: ${changelog.path}
      comment: "Standardize databasechangelog filenames to match logicalFilePath"
      runOnChange: true
      changes:
        - sqlFile:
            path: changesets/migration/M003_fix_changelog_filenames.sql
            relativeToChangelogFile: true
            splitStatements: false
      rollback:
        - sqlFile:
            path: changesets/migration/M003_fix_changelog_filenames_rollback.sql
            relativeToChangelogFile: true
            splitStatements: false

  - changeSet:
      id: tag-v1.0.0
      author: hemis-team
      logicalFilePath: ${changelog.path}
      changes:
        - tagDatabase:
            tag: v1.0.0
