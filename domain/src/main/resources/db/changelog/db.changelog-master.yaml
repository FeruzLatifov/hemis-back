# =====================================================
# HEMIS Backend - Liquibase Master Changelog
# =====================================================
# Senior Architect: Clean, Consolidated Migrations
# Migrated from: hemis-back-main Flyway migrations
# Date: 2025-01-12
#
# Strategy:
# ✅ No duplication - all migrations consolidated
# ✅ Logical grouping - schema, data, migration, translations
# ✅ Complete rollback support
# ✅ Best practice naming and structure
#
# Original source: 15 Flyway files (3774 lines)
# Consolidated to: 4 Liquibase changesets (2883 lines)
# =====================================================

databaseChangeLog:
  # =====================================================
  # V1: Complete Database Schema
  # =====================================================
  # Creates all required tables:
  # - Authentication: users, roles, permissions
  # - RBAC: user_roles, role_permissions
  # - I18n: h_system_message, h_system_message_translation
  #
  # Total: 7 tables with indexes and constraints
  # Source: V1 + V5 from main (consolidated)
  # =====================================================

  - changeSet:
      id: v1-complete-schema
      author: hemis-team
      comment: Create complete database schema (auth + i18n tables)
      context: "!test"
      labels: "schema,ddl"
      runOnChange: false

      sqlFile:
        path: changesets/01-complete-schema.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: false

      rollback:
        sqlFile:
          path: changesets/01-complete-schema-rollback.sql
          relativeToChangelogFile: true

  # Tag after V1 for rollback support
  - changeSet:
      id: tag-v1
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v1-schema-complete
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

  # =====================================================
  # V2: Complete Seed Data
  # =====================================================
  # Seeds all required data:
  # - 1 admin user (username: admin, password: admin)
  # - 5 roles (SUPER_ADMIN, ADMINISTRATORS, etc.)
  # - 90 permissions (30 basic CRUD + 60 menu permissions)
  # - Role-permission assignments (all to ADMINISTRATORS)
  # - User-role assignments
  #
  # Menu permissions structure:
  # - Dashboard (1)
  # - Registry (4)
  # - Rating (14)
  # - Data Management (10)
  # - Reports (25)
  # - System (6)
  #
  # Source: V2 + V9 from main (consolidated)
  # =====================================================

  - changeSet:
      id: v2-complete-seed-data
      author: hemis-team
      comment: Seed complete data (roles + permissions only, NO admin user)
      context: "!test"
      labels: "data,seed"
      runOnChange: false

      sqlFile:
        path: changesets/02-complete-seed-data.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: false
        # CRITICAL: DO NOT split - file contains PL/pgSQL blocks (DO $$)

      rollback:
        sqlFile:
          path: changesets/02-complete-seed-data-rollback.sql
          relativeToChangelogFile: true

  # Tag after V2 for rollback support
  - changeSet:
      id: tag-v2
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v2-seed-data-complete
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

  # =====================================================
  # V3: Migrate Old-Hemis Users
  # =====================================================
  # Migrates existing data from old-hemis CUBA:
  # - Roles: sec_role → roles
  # - Users: sec_user → users (357 users)
  # - Mappings: sec_user_role → user_roles
  #
  # Strategy: Hybrid approach
  # - Preserves original UUIDs for integrity
  # - Keeps BCrypt passwords as-is
  # - Only migrates active records (delete_ts IS NULL)
  # - Skips duplicates (ON CONFLICT DO NOTHING)
  #
  # Source: V3 from main
  # =====================================================

  # =====================================================
  # V3: Migrate Old-Hemis Users (sec_user → users)
  # =====================================================
  # Strategy: Simple SQL INSERT statements (NO PL/pgSQL)
  # Migrates all active users and their role mappings
  # =====================================================

  - changeSet:
      id: v3-migrate-old-hemis-users
      author: hemis-team
      comment: Migrate users from old-hemis (sec_user → users) using simple SQL
      context: "!test"
      labels: "data,migration"
      runOnChange: false

      preConditions:
        onFail: MARK_RAN
        tableExists:
          tableName: sec_user

      sqlFile:
        path: changesets/03-migrate-old-users.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: true
        endDelimiter: ";"

      rollback:
        sqlFile:
          path: changesets/03-migrate-old-users-rollback.sql
          relativeToChangelogFile: true

  # Tag after V3 for rollback support
  - changeSet:
      id: tag-v3
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v3-users-migrated
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

  # =====================================================
  # V4: Complete Menu Translations
  # =====================================================
  # Complete translation system for menu:
  # - 127 menu items with full nested structure
  # - 4 languages: uz-UZ, oz-UZ (Cyrillic), ru-RU, en-US
  # - Total: 508 translation records (127 × 4)
  #
  # Menu structure (6 main sections):
  # 1. Dashboard
  # 2. Registry (Reestlar) - 19 nested items
  # 3. Rating (Reyting) - 14 nested items
  # 4. Data Management - 44 nested items
  # 5. Reports (Hisobotlar) - 43 nested items
  # 6. System (Tizim) - 6 items
  #
  # Source: V10 + V12 + V13 + V14 + V15 from main (consolidated)
  # =====================================================

  - changeSet:
      id: v4-complete-menu-translations
      author: hemis-team
      comment: Complete menu translations (127 items × 4 languages = 508 records)
      context: "!test"
      labels: "i18n,menu,translations"
      runOnChange: false

      sqlFile:
        path: changesets/04-complete-translations.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: false

      rollback:
        sqlFile:
          path: changesets/04-complete-translations-rollback.sql
          relativeToChangelogFile: true

  # Tag after V4 for rollback support
  - changeSet:
      id: tag-v4
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v4-menu-translations-complete
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

  # =====================================================
  # V5: Faculty Registry Translations
  # =====================================================
  # Add translations for Faculty Registry module:
  # - Menu: menu.registry.faculty
  # - Table columns: table.faculty.* (8 fields)
  # - Actions: actions.view, actions.close
  # - Details drawer: details.* (8 fields)
  #
  # Languages: uz-UZ, oz-UZ (Cyrillic), ru-RU, en-US
  # Total: ~50 new translation records
  #
  # Source: Faculty Registry Module (new feature)
  # =====================================================

  - changeSet:
      id: v5-faculty-registry-translations
      author: hemis-team
      comment: Add Faculty Registry translations (menu + table + actions + details)
      context: "!test"
      labels: "i18n,translations,faculty"
      runOnChange: false

      sqlFile:
        path: changesets/05-faculty-registry-translations.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: false

      rollback:
        sqlFile:
          path: changesets/05-faculty-registry-translations-rollback.sql
          relativeToChangelogFile: true

  # Tag after V5 for rollback support
  - changeSet:
      id: tag-v5
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v5-faculty-translations-complete
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

  # =====================================================
  # V6: Menu Permissions (Registry, Rating, Data, System)
  # =====================================================
  # Add complete menu structure permissions from old-hemis:
  # - Registry Module (4 permissions)
  # - Rating Module (14 permissions)
  # - Data Management (10 permissions)
  # - Reports Module (24 permissions)
  # - System Module (6 permissions)
  #
  # Total: 58 new permissions
  # All assigned to Super Administrator role
  #
  # Source: V9__Update_Menu_Structure_Permissions.sql (Flyway backup)
  # =====================================================

  - changeSet:
      id: v6-add-menu-permissions
      author: hemis-team
      comment: Add complete menu structure permissions (58 permissions)
      context: "!test"
      labels: "permissions,menu"
      runOnChange: false

      sqlFile:
        path: changesets/06-add-menu-permissions.sql
        relativeToChangelogFile: true
        stripComments: false
        splitStatements: false

      rollback:
        sqlFile:
          path: changesets/06-add-menu-permissions-rollback.sql
          relativeToChangelogFile: true
          stripComments: false
          splitStatements: false

  # Tag after V6 for rollback support
  - changeSet:
      id: tag-v6
      author: hemis-team
      changes:
        - tagDatabase:
            tag: v6-menu-permissions-complete
      rollback:
        - sql:
            sql: "-- Tag rollback (no-op)"

# =====================================================
# Liquibase Commands
# =====================================================
# Apply all:      ./gradlew bootRun
# Rollback last:  ./gradlew :domain:liquibaseRollbackCount -Pcount=1
# Rollback to V5: ./gradlew :domain:liquibaseRollbackCount -Pcount=2
# Status:         ./gradlew :domain:liquibaseStatus
#
# IMPORTANT: Rollback requires splitStatements=false for PostgreSQL DO $$ blocks
# All rollback SQL files must include this configuration
# =====================================================
