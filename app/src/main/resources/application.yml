# =====================================================
# HEMIS Application Configuration
# =====================================================
# Stack: Spring Boot 3.5.7 + JDK 25 + PostgreSQL 17
# Mode: NO-RENAME ‚Ä¢ NO-DELETE ‚Ä¢ NO-BREAKING-CHANGES
# =====================================================

spring:
  application:
    name: hemis

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
    # include: redis  # Disabled - using JWT (stateless), not Redis sessions

  # =====================================================
  # Lazy Initialization (fixes Sentry BeanPostProcessor warnings)
  # =====================================================
  main:
    lazy-initialization: false  # Global lazy disabled
    allow-bean-definition-overriding: false

  # =====================================================
  # DataSource Configuration (Master/Replica)
  # =====================================================
  # CRITICAL: Connects to existing ministry.sql database
  # NO schema generation - Liquibase migrations only
  # Master: Write operations (CREATE, UPDATE, DELETE)
  # Replica: Read operations (SELECT)
  # =====================================================

  datasource:
    # Master Database (Write Operations)
    master:
      jdbc-url: jdbc:postgresql://${DB_MASTER_HOST}:${DB_MASTER_PORT}/${DB_MASTER_NAME}
      username: ${DB_MASTER_USERNAME}
      password: ${DB_MASTER_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        maximum-pool-size: 10
        minimum-idle: 2
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: HikariPool-Master
        auto-commit: false
        data-source-properties:
          ApplicationName: HEMIS-Master

    # Replica Database (Read Operations)
    replica:
      jdbc-url: jdbc:postgresql://${DB_REPLICA_HOST}:${DB_REPLICA_PORT}/${DB_REPLICA_NAME}
      username: ${DB_REPLICA_USERNAME}
      password: ${DB_REPLICA_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: HikariPool-Replica
        read-only: true
        auto-commit: false
        data-source-properties:
          ApplicationName: HEMIS-Replica

  # =====================================================
  # Redis Configuration (OAuth2 Token Storage)
  # =====================================================
  # CRITICAL: OLD-HEMIS uses Redis for token storage
  # Same Redis structure for backward compatibility
  # =====================================================

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 60000
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1

  # =====================================================
  # Spring Cache Configuration
  # =====================================================
  # Managed by DashboardCacheConfig.java (@Primary CacheManager bean)
  # - Supports: menu, i18n, userPermissions, stats
  # - TTL: 60 minutes (default), 30 minutes (dashboard)
  # - Backend: Redis with JSON serialization
  # - Prefix: cache:
  # =====================================================

  # =====================================================
  # JPA/Hibernate Configuration
  # =====================================================
  # CRITICAL: ddl-auto=none - NO schema generation
  # Entities mapped via @Table/@Column to existing tables
  # =====================================================

  jpa:
    hibernate:
      ddl-auto: none  # NEVER generate schema

    show-sql: false
    open-in-view: false

    properties:
      hibernate:
        # Dialect auto-detected - do NOT set hibernate.dialect
        format_sql: true
        use_sql_comments: false
        default_schema: public

        # Query optimization
        query:
          plan_cache_max_size: 2048

        # Batch processing
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # =====================================================
  # Jackson Configuration
  # =====================================================

  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      indent-output: true
    deserialization:
      fail-on-unknown-properties: false
    time-zone: Asia/Tashkent

# =====================================================
# SpringDoc OpenAPI (Swagger) Configuration
# =====================================================
# Multi-Group Configuration for Audience-Based Separation
# =====================================================

springdoc:
  # Global API Docs Settings
  api-docs:
    enabled: true
    path: /v3/api-docs

  # Swagger UI Settings
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    disable-swagger-default-url: true
    display-request-duration: true
    filter: false # Dropdown'ni o'chirish
    tags-sorter: alpha
    operations-sorter: alpha
    doc-expansion: none
    default-models-expand-depth: 1
    default-model-expand-depth: 1
    try-it-out-enabled: true
    # Dark Theme CSS
    custom-css-path: /swagger-ui/swagger-ui-dark.css

    # Alohida URLs - har biri faqat o'z API'sini ko'radi
    # /docs/web ‚Üí Web Frontend API
    # /docs/university ‚Üí Universitet API

  # Show actuator endpoints in Swagger
  show-actuator: false

  # Disable default ResponseEntity wrapping
  override-with-generic-response: false

  # =====================================================
  # Multi-Group API Documentation
  # =====================================================
  # Note: Groups configured in OpenApiConfig.java
  # - üåê web: Web Frontend API v1 (/api/v1/web/**)
  # - üéì external: Universities & Organizations (/app/rest/v2/**)
  # - üì¶ legacy: Old-HEMIS compatible (entities/services)
  # - üéØ all: Complete documentation (internal)
  # =====================================================

# =====================================================
# Server Configuration
# =====================================================
# CRITICAL: Port 8080 for legacy API compatibility
# =====================================================

server:
  port: ${SERVER_PORT:8081}

  servlet:
    context-path: /

  compression:
    enabled: true
    mime-types:
      - text/html
      - text/xml
      - text/plain
      - text/css
      - application/javascript
      - application/json

  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param
    include-exception: false

# =====================================================
# Actuator Configuration
# =====================================================

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,mappings

  endpoint:
    health:
      show-details: when-authorized

  health:
    db:
      enabled: true

# =====================================================
# Logging Configuration
# =====================================================

logging:
  level:
    root: INFO
    uz.hemis: INFO
    org.springframework: INFO
    org.hibernate: INFO
    # Suppress Hibernate dialect deprecation warning
    org.hibernate.orm.deprecation: ERROR
    # Suppress AuthenticationProvider warning (configuration is intentional)
    org.springframework.security.config.annotation.authentication.configuration.InitializeUserDetailsBeanManagerConfigurer: ERROR

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# =====================================================
# Application-Specific Configuration
# =====================================================

hemis:
  # Swagger/OpenAPI configuration
  swagger:
    # Base URL for Swagger UI server selector
    server-url: ${SWAGGER_SERVER_URL:http://localhost:${SERVER_PORT:8081}}

  # API Configuration
  api:
    # Legacy CUBA REST API base path
    base-path: /app/rest/v2

  # External API Configuration (Government Services)
  external:
    # Personal Data Service (MVD Integration)
    personal-data:
      url: ${PERSONAL_DATA_URL:https://talaba.edu.uz/api/my_edu_uz/student_mvd_hemis.php}
      token: ${PERSONAL_DATA_TOKEN:12345}

    # Passport Data Service (Government Passport API)
    passport-data:
      url: ${PASSPORT_DATA_URL:https://api.gov.uz/passport}
      token: ${PASSPORT_DATA_TOKEN:}

    # BIMM Service (Beneficiary Information Management System)
    bimm:
      url: ${BIMM_URL:https://api.gov.uz/bimm}
      token: ${BIMM_TOKEN:}

    # Social Service (Social Registries and Support Programs)
    social:
      url: ${SOCIAL_URL:https://api.gov.uz/social}
      token: ${SOCIAL_TOKEN:}

  # CORS Configuration (for frontend)
  cors:
    allowed-origins:
      - ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:5173}
    allowed-methods:
      - GET
      - POST
      - PUT
      - PATCH
      - OPTIONS
    allowed-headers:
      - "*"
    exposed-headers:
      - Authorization
      - X-Total-Count
    allow-credentials: true
    max-age: 3600

  # Security Configuration
  security:
    jwt:
      # JWT Secret Key (for HMAC-SHA256 signing)
      secret: ${JWT_SECRET:aGVtaXMtc2VjcmV0LWtleS0yMDI1LWNoYW5nZS1tZS1pbi1wcm9kdWN0aW9uLWhlbWlzLXNlY3JldC1rZXk=}
      # Token expiration (seconds) - default: 12 hours
      expiration: ${JWT_EXPIRATION:43200}
      # Refresh token expiration (seconds) - default: 7 days
      refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}
      # Issuer
      issuer: ${JWT_ISSUER:hemis-backend}
      # Public key or JWK Set URI for JWT validation (optional)
      jwk-set-uri: ${JWT_JWK_SET_URI:}
      issuer-uri: ${JWT_ISSUER_URI:}
    oauth:
      # Legacy client credentials (Basic auth)
      client-id: ${OAUTH_CLIENT_ID:client}
      client-secret: ${OAUTH_CLIENT_SECRET:secret}
      # Scope returned in token responses
      scope: ${OAUTH_SCOPE:rest-api}

# =====================================================
# Spring Security OAuth2 Resource Server
# =====================================================
# JWT validation configuration
# Set one of the following:
#   - jwk-set-uri: URL to JWK Set (e.g., https://auth-server/.well-known/jwks.json)
#   - issuer-uri: Issuer URL (auto-discovers JWK Set URI)
# =====================================================

spring.security.oauth2.resourceserver:
  jwt:
    # JWK Set URI for token validation
    jwk-set-uri: ${JWT_JWK_SET_URI:}

    # OR Issuer URI (auto-discovers JWK Set URI)
    issuer-uri: ${JWT_ISSUER_URI:}

# =====================================================
# Legacy Fallback (old-HEMIS)
# =====================================================
legacy:
  old-hemis:
    base-url: ${OLD_HEMIS_BASE_URL:http://localhost:8081}

    # JWT validation settings
    # audiences: ${JWT_AUDIENCES:hemis-api}
    # principle-claim-name: sub

  # Database Configuration
  database:
    # Read-only mode enforcement (NO DELETE/TRUNCATE)
    read-only: false  # Set to true for read-only replicas
    enforce-no-delete: true  # Block DELETE operations at app level

# =====================================================
# ‚≠ê Sentry Error Tracking & Performance Monitoring
# =====================================================
# Spring Boot auto-configuration (v8.16.0+)
# Configure via environment variables or application.yml
# =====================================================
sentry:
  enabled: ${SENTRY_ENABLED:false}
  dsn: ${SENTRY_DSN:}
  environment: ${SENTRY_ENVIRONMENT:${spring.profiles.active}}
  traces-sample-rate: ${SENTRY_TRACES_SAMPLE_RATE:0.0}
  
  # In-app packages (for stack traces)
  in-app-includes:
    - uz.hemis

