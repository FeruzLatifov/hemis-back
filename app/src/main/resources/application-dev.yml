# =====================================================
# HEMIS Development Profile
# =====================================================

spring:
  # =====================================================
  # Auto-Configuration Exclusions (to reduce warnings)
  # =====================================================
  autoconfigure:
    exclude:
      - io.sentry.spring.boot.jakarta.SentryAutoConfiguration  # Exclude Sentry when disabled
      
  # =====================================================
  # Development DataSource
  # =====================================================
  # Development: Single database (no master/replica split)
  # .env fayldan o'qiydi: DB_MASTER_HOST, DB_MASTER_NAME, etc.
  # =====================================================

  datasource:
    url: jdbc:postgresql://${DB_MASTER_HOST}:${DB_MASTER_PORT}/${DB_MASTER_NAME}
    username: ${DB_MASTER_USERNAME}
    password: ${DB_MASTER_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      pool-name: HikariPool-Dev

  # =====================================================
  # Development JPA Configuration
  # =====================================================

  jpa:
    show-sql: false  # SQL loglarni o'chirish

    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true

  # =====================================================
  # Development Security Configuration
  # =====================================================
  # Cookie settings for localhost HTTP testing
  # =====================================================

# Application-specific settings
app:
  security:
    cookie:
      secure: false  # ✅ localhost HTTP uchun (setSecure: false)
      same-site: Lax
      domain: localhost

  # =====================================================
  # Development Liquibase Configuration
  # =====================================================
  # ✅ AUTOMATIC MIGRATIONS (Best Practice for Development)
  # Runs on every application startup
  # Database lock prevents concurrent execution
  # =====================================================

  liquibase:
    # Enable automatic migrations in development
    enabled: true  # ✅ Automatic migrations (Spring Boot default)

    # Changelog location
    change-log: classpath:/db/changelog/db.changelog-master.yaml

    # Default schema
    default-schema: public

    # Safety settings
    drop-first: false  # NEVER drop database

    # Context for environment-specific changesets
    contexts: dev
    
    # Database changelog lock (prevents concurrent migrations)
    # Spring Boot Liquibase automatically uses DATABASECHANGELOGLOCK table
    # to ensure only ONE instance runs migrations at a time

  # =====================================================
  # Redis Configuration - ENABLED for Permission Caching
  # =====================================================

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      jedis:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  cache:
    type: redis  # Enable Redis cache
    redis:
      time-to-live: 3600000  # 1 hour (in milliseconds)
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "hemis:"

# =====================================================
# Cache Warmup Configuration - OPTIMIZATION
# =====================================================
# ✅ LAZY LOADING STRATEGY (Industry Best Practice)
# Login → Cache Miss (50-100ms, acceptable!)
# Subsequent → Cache Hit (<1ms)
# =====================================================
cache:
  warmup:
    menu:
      enabled: false  # ✅ DISABLED: Lazy loading strategy (46s → 5s startup!)
      mode: role-based
      critical-roles:
        - SUPER_ADMIN
      max-users-per-role: 0  # No warmup

  # =====================================================
  # DevTools (COMPLETELY DISABLED - Prevents restart loops)
  # =====================================================
  # ⚠️ DevTools completely disabled to prevent restart loops
  # Manual restart: Ctrl+C and re-run ./gradlew :app:bootRun
  # =====================================================

  devtools:
    restart:
      enabled: false  # ✅ FIX: Disabled to prevent restart loops
      additional-paths:
        - src/main/java

    livereload:
      enabled: false  # ✅ Disabled for stability

    add-properties: false  # ✅ CRITICAL: Prevents DevTools property defaults

# =====================================================
# Server Configuration (Development)
# =====================================================

server:
  port: 8081

  error:
    include-stacktrace: always  # Full stack traces in dev

# =====================================================
# Logging (Development - Verbose)
# =====================================================

logging:
  level:
    root: INFO
    uz.hemis: INFO  # DEBUG → INFO (kamroq log)
    org.springframework.web: INFO  # DEBUG → INFO
    org.springframework.security: INFO  # DEBUG → INFO
    org.hibernate.SQL: INFO  # DEBUG → INFO (SQL loglarni o'chirish)
    org.hibernate.type.descriptor.sql.BasicBinder: INFO  # TRACE → INFO
    liquibase: INFO
    liquibase.changelog: INFO
    # Suppress AuthenticationProvider warning (configuration is intentional)
    org.springframework.security.config.annotation.authentication.configuration.InitializeUserDetailsBeanManagerConfigurer: ERROR

  pattern:
    console: "%clr(%d{HH:mm:ss.SSS}){faint} %clr(%5p) %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n%wEx"

# =====================================================
# HEMIS Development Configuration
# =====================================================

hemis:
  cors:
    allowed-origins:
      - http://localhost:3000
      - http://localhost:5173
      - http://127.0.0.1:3000
      - http://127.0.0.1:5173

  security:
    jwt:
      # Development JWT configuration (OLD-HEMIS compatible)
      secret: ${JWT_SECRET:dev-secret-key-change-in-production-this-is-only-for-development-min-64-chars}
      expiration: ${JWT_EXPIRATION:43200}  # 12 hours in seconds (OLD-HEMIS: 43199)
      refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}  # 7 days in seconds
      jwk-set-uri: ${JWT_JWK_SET_URI:}

  database:
    enforce-no-delete: true  # Still enforce in dev

# =====================================================
# SpringDoc OpenAPI (Swagger) Configuration
# =====================================================

springdoc:
  api-docs:
    path: /v3/api-docs  # OpenAPI JSON
    enabled: true

  swagger-ui:
    path: /swagger-ui.html  # Swagger UI page
    enabled: true
    try-it-out-enabled: true  # Enable "Try it out" button
    operations-sorter: method  # Sort by HTTP method
    tags-sorter: alpha  # Alphabetical (with 00., 01. ... normalized)
    doc-expansion: none  # Collapse all tags and operations by default
    display-request-duration: true
    default-models-expand-depth: 3
    filter: true
    urlsPrimaryName: all

  # Show only public methods
  show-actuator: false

# =====================================================
# Development Notes
# =====================================================
# - Database: External PostgreSQL (configure via env vars)
# - Redis: Docker (localhost:6379)
# - Run with: ./gradlew :app:bootRun
# - Or: Run HemisApplication.java in IntelliJ
# - Hot reload enabled (DevTools)
# - SQL logging enabled
# - Full stack traces on errors
# =====================================================

# =====================================================
# Liquibase Configuration (Global Override)
# =====================================================
# NOTE: Can be overridden per profile
# 
# Manual migration commands (for emergency rollback):
# - ./gradlew :domain:liquibaseStatus
# - ./gradlew :domain:liquibaseRollbackCount -Pcount=1
# - ./gradlew :domain:liquibaseHistory
# =====================================================

# No global override - each profile controls liquibase.enabled
